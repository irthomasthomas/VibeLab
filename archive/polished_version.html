<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeLab - Polished Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --grid-gap: 1.5rem;
            --svg-min-size: 280px; /* Base size for SVG display areas */
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #64748b;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .workspace {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .prompt-box {
            margin-bottom: 2rem; /* Reduced margin */
            text-align: center;
        }
        
        .prompt-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .prompt-text {
            font-style: italic;
            background: #f0f9ff;
            display: inline-block;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1.2rem;
            color: #1e293b;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--svg-min-size) + 50px), 1fr));
            gap: var(--grid-gap);
            margin-bottom: 2rem; /* Reduced margin to bring ranking closer */
            justify-content: center;
        }
        
        .svg-container {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            cursor: move;
            border: 2px solid transparent;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: calc(var(--svg-min-size) + 40px); /* Ensure enough height */
        }
        
        .svg-container:hover {
            border-color: #3b82f6;
        }
        
        .svg-container.dragging {
            opacity: 0.7;
            transform: rotate(3deg) scale(1.05); /* Slightly lift and scale when dragging */
            z-index: 100;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .svg-container.keyboard-selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px #dbeafe;
        }
        
        .svg-preview {
            height: var(--svg-min-size); /* Use variable for consistency */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allow preview to take available space */
        }
        
        .svg-preview svg {
            width: 100%; 
            height: 100%;
            max-width: calc(var(--svg-min-size) - 20px); /* Ensure padding within preview area */
            max-height: calc(var(--svg-min-size) - 40px); /* Ensure padding within preview area */
            border-radius: 6px;
            background: white;
        }
        
        .shortcut-hint {
            position: absolute;
            top: 8px; /* Adjusted position */
            right: 8px; /* Adjusted position */
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .ranking-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .section-title {
            text-align: center;
            font-size: 1.8rem;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        
        .ranking-instructions {
            text-align: center;
            color: #64748b;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        .ranking-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Slightly wider slots */
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .ranking-slot {
            min-height: 250px; /* Increased min-height for larger preview */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Adjust content distribution */
            position: relative;
            padding: 1rem; /* Reduced padding */
            transition: all 0.3s ease;
        }
        
        .ranking-slot.empty {
            border: 3px dashed #cbd5e1;
            background: #f8fafc;
        }
        
        .ranking-slot.filled {
            background: white;
            border: 3px solid #cbd5e1; /* Keep border for consistency */
        }
        
        .ranking-slot.rank-1 { border-color: #10b981; }
        .ranking-slot.rank-2 { border-color: #f59e0b; }
        .ranking-slot.rank-3 { border-color: #ef4444; }
        .ranking-slot.rank-4 { border-color: #6b7280; }
        
        .ranking-slot.drag-over {
            background: #e0f2fe; /* Feedback for drag over */
        }
        
        .slot-label {
            font-weight: 700;
            margin-bottom: 0.5rem; /* Reduced margin */
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        .slot-icon {
            margin-right: 0.75rem;
            font-size: 1.6rem;
        }
        
        .rank-1 .slot-icon { color: #10b981; }
        .rank-2 .slot-icon { color: #f59e0b; }
        .rank-3 .slot-icon { color: #ef4444; }
        .rank-4 .slot-icon { color: #6b7280; }

        /* Styling for the SVG preview inside the ranking slot */
        .ranking-slot .svg-preview {
            width: 100%;
            height: 130px; /* Increased height for SVG preview */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem; /* Space before technique name */
        }
        .ranking-slot .svg-preview svg {
            width: 160px; /* Increased width of SVG preview */
            height: 120px; /* Increased height of SVG preview */
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        
        .technique-name {
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
            margin-top: 0.5rem; /* Reduced margin */
            text-align: center;
            font-style: italic;
            min-height: 2.5em; /* Ensure space for two lines of text */
        }
        
        .keyboard-shortcuts {
            background: #f0f9ff;
            border: 2px dashed #38bdf8;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 2rem;
            text-align: center;
        }
        
        .keys {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .key {
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 700;
            position: relative;
        }
        
        .key::after {
            content: "";
            display: block;
            text-align: center;
            color: #64748b;
            font-size: 0.8rem;
            font-weight: normal;
            margin-top: 0.5rem;
        }
        
        .key[data-key="1"]::after { content: "Best"; }
        .key[data-key="2"]::after { content: "Good"; }
        .key[data-key="3"]::after { content: "Fair"; }
        .key[data-key="4"]::after { content: "Poor"; }
        
        .analytics-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .chart-container {
            margin: 2rem 0;
            height: 400px;
            position: relative;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #1e293b;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 3rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
        }
        
        .btn-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #cbd5e1;
        }
        
        .btn-analytics {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .btn-primary:hover { box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4); }
        .btn-analytics:hover { box-shadow: 0 6px 15px rgba(139, 92, 246, 0.4); }
        
        .progress-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 100;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .status-value {
            font-weight: 600;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 VibeLab Polished</h1>
            <p>Optimal SVGs • Inline Technique Reveal • Auto-next Workflow • Visual Analytics • Keyboard & D&D</p>
        </div>

        <div class="workspace">
            <div class="prompt-box">
                <div class="prompt-label">Current Evaluation Task:</div>
                <div class="prompt-text" id="currentPrompt">"Photorealistic landscape with mountains, river, forest, and sunset"</div>
            </div>

            <div class="comparison-grid" id="comparisonGrid">
                <div class="svg-container" draggable="true" data-output="A" data-technique="baseline">
                    <div class="shortcut-hint">A</div>
                    <div class="svg-preview" id="svgA">
                        <!-- SVG will be inserted here -->
                    </div>
                </div>
                <div class="svg-container" draggable="true" data-output="B" data-technique="few-shot">
                    <div class="shortcut-hint">B</div>
                    <div class="svg-preview" id="svgB">
                        <!-- SVG will be inserted here -->
                    </div>
                </div>
                <div class="svg-container" draggable="true" data-output="C" data-technique="chain-of-thought">
                    <div class="shortcut-hint">C</div>
                    <div class="svg-preview" id="svgC">
                        <!-- SVG will be inserted here -->
                    </div>
                </div>
                <div class="svg-container" draggable="true" data-output="D" data-technique="role-playing">
                    <div class="shortcut-hint">D</div>
                    <div class="svg-preview" id="svgD">
                        <!-- SVG will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="ranking-section">
            <div class="section-title">Rank the Results</div>
            <div class="ranking-instructions">
                Drag outputs or use number keys (1-4 on selected SVG) to rank. Submit when complete.
            </div>
            
            <div class="ranking-slots">
                <div class="ranking-slot rank-1 empty" data-rank="1">
                    <div class="slot-label">
                        <span class="slot-icon">🥇</span> Best
                    </div>
                    <div class="svg-preview"></div> <!-- Container for dropped SVG -->
                    <div class="technique-name"></div>
                </div>
                <div class="ranking-slot rank-2 empty" data-rank="2">
                    <div class="slot-label">
                        <span class="slot-icon">🥈</span> Good
                    </div>
                    <div class="svg-preview"></div>
                    <div class="technique-name"></div>
                </div>
                <div class="ranking-slot rank-3 empty" data-rank="3">
                    <div class="slot-label">
                        <span class="slot-icon">🥉</span> Fair
                    </div>
                    <div class="svg-preview"></div>
                    <div class="technique-name"></div>
                </div>
                <div class="ranking-slot rank-4 empty" data-rank="4">
                    <div class="slot-label">
                        <span class="slot-icon">❌</span> Poor
                    </div>
                    <div class="svg-preview"></div>
                    <div class="technique-name"></div>
                </div>
            </div>

            <div class="keyboard-shortcuts">
                <div>Click an SVG then press number keys to rank:</div>
                <div class="keys">
                    <div class="key" data-key="1">1</div>
                    <div class="key" data-key="2">2</div>
                    <div class="key" data-key="3">3</div>
                    <div class="key" data-key="4">4</div>
                </div>
                <div>(A, B, C, D maps to 1, 2, 3, 4 for keyboard selection if no click)</div>
            </div>
        </div>

        <div class="analytics-panel">
            <div class="section-title">Performance Analytics</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="analyticsTotalEvals">0</div>
                    <div class="stat-label">Completed Evaluations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsAvgTime">0s</div>
                    <div class="stat-label">Avg Time per Eval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsTopTech">N/A</div>
                    <div class="stat-label">Top Performing Technique</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsBaselineWins">0%</div>
                    <div class="stat-label">Baseline #1 Rank Rate</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="winRateChart"></canvas>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" id="submitBtn">
                <span class="btn-icon">✅</span> Submit & Next Batch
            </button>
            <button class="btn btn-analytics" id="analyticsBtn">
                <span class="btn-icon">📊</span> Toggle Analytics
            </button>
            <button class="btn btn-secondary" id="resetSessionBtn">
                <span class="btn-icon">🔄</span> Reset Session
            </button>
        </div>
    </div>

    <div class="progress-indicator">
        <div class="status-item">
            <span>Evaluations:</span>
            <span class="status-value"><span id="evalCount">0</span>/<span id="evalTotal"></span></span>
        </div>
        <div class="status-item">
            <span>Batch:</span>
            <span class="status-value" id="currentBatchName">N/A</span>
        </div>
        <div class="status-item">
            <span>Timer:</span>
            <span class="status-value" id="batchTimer">0s</span>
        </div>
    </div>

    <script>
        // Sample SVG data for multi-set rotation
        const svgDataStore = {
            "nature": {
                prompt: "Photorealistic landscape with mountains, river, forest, and sunset",
                outputs: [
                    { id: "A", technique: "baseline", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#87CEEB"/><polygon points="0,150 50,50 100,150" fill="#A0522D"/><circle cx="150" cy="40" r="20" fill="#FFD700"/><rect y="100" width="200" height="50" fill="#228B22"/></svg>` },
                    { id: "B", technique: "few-shot", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#ADD8E6"/><path d="M0 100 Q 50 50 100 100 T 200 100" fill="#6B8E23" stroke="#556B2F"/><ellipse cx="160" cy="30" rx="25" ry="15" fill="#FFA500"/><rect y="120" width="200" height="30" fill="#32CD32"/></svg>` },
                    { id: "C", technique: "chain-of-thought", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#B0E0E6"/><polygon points="10,120 60,20 110,120" fill="#D2B48C" stroke="#8B4513"/><ellipse cx="170" cy="20" rx="15" ry="10" fill="#FFDEAD"/><rect y="110" width="200" height="40" fill="#90EE90" stroke="#006400"/></svg>` },
                    { id: "D", technique: "role-playing", svg: `<svg viewBox="0 0 200 150"><linearGradient id="skyGradPolished" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FF7F50"/><stop offset="100%" stop-color="#1E90FF"/></linearGradient><rect width="200" height="150" fill="url(#skyGradPolished)"/><path d="M0 150 L0 90 C 50 70, 150 70, 200 90 L200 150 Z" fill="#20B2AA"/><circle cx="100" cy="25" r="12" fill="#FFFFE0"/></svg>` }
                ]
            },
            "urban": {
                prompt: "Modern cityscape at night with skyscrapers, bridges and lights",
                outputs: [
                    { id: "A", technique: "baseline", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#000033"/><rect x="20" y="50" width="30" height="100" fill="#778899"/><rect x="70" y="30" width="40" height="120" fill="#A9A9A9"/><circle cx="150" cy="20" r="10" fill="#FFFF00"/></svg>` },
                    { id: "B", technique: "few-shot", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#191970"/><rect x="10" y="70" width="20" height="80" fill="#D3D3D3"/><rect x="50" y="20" width="25" height="130" fill="#BEBEBE"/><rect x="90" y="50" width="30" height="100" fill="#C0C0C0"/><circle cx="170" cy="40" r="8" fill="#FFD700"/></svg>` },
                    { id: "C", technique: "chain-of-thought", svg: `<svg viewBox="0 0 200 150"><rect width="200" height="150" fill="#2F4F4F"/><rect x="30" y="10" width="30" height="140" fill="#808080" stroke="#696969"/><rect x="80" y="40" width="40" height="110" fill="#708090" stroke="#506070"/><rect x="140" y="60" width="20" height="90" fill="#696969" stroke="#494949"/><path d="M0 130 Q 100 100 200 130" stroke="#FFFFFF" stroke-width="3" fill="none"/></svg>` },
                    { id: "D", technique: "role-playing", svg: `<svg viewBox="0 0 200 150"><linearGradient id="cityNight" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0000CD"/><stop offset="100%" stop-color="#4B0082"/></linearGradient><rect width="200" height="150" fill="url(#cityNight)"/><path d="M10 140 V50 H30 V140 Z M40 140 V20 H70 V140 Z M80 140 V70 H110 V140Z" fill="#C0C0C0" opacity="0.3"/><ellipse cx="150" cy="30" rx="15" ry="8" fill="#FFFACD"/></svg>` }
                ]
            }
        };
        
        let rankings = {};
        let currentBatchName = "";
        let currentBatchOutputs = [];
        let selectedSVGId = null; // For keyboard selection
        
        let sessionData = {
            evaluations: [], // {batchName, prompt, rankings: {rank: {id, technique}}, timeTaken}
            totalEvaluations: 0,
            startTime: null,
            batchStartTime: null
        };
        const MAX_EVALUATIONS = 8; // For demo purposes

        // Chart instance
        let winRateChart = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupEventListeners();
            loadNextBatch();
            updateProgressIndicator();
            document.getElementById('evalTotal').textContent = MAX_EVALUATIONS;
        });

        function loadNextBatch() {
            if (sessionData.totalEvaluations >= MAX_EVALUATIONS) {
                alert("Maximum evaluations for this demo session reached!");
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            const batchKeys = Object.keys(svgDataStore);
            currentBatchName = batchKeys[sessionData.totalEvaluations % batchKeys.length];
            const batchData = svgDataStore[currentBatchName];
            
            document.getElementById('currentPrompt').textContent = batchData.prompt;
            currentBatchOutputs = batchData.outputs; // Store for later reference
            
            // Shuffle outputs for true blinding
            const shuffledOutputs = [...batchData.outputs].sort(() => 0.5 - Math.random());

            // Assign to fixed shortcut hints A, B, C, D (conceptually)
            // but the actual technique is now only in currentBatchOutputs by its original ID
            const gridContainers = document.querySelectorAll('.svg-container');
            gridContainers.forEach((container, index) => {
                const outputData = shuffledOutputs[index];
                container.dataset.outputId = outputData.id; // This is the key for identifying the original SVG
                container.dataset.technique = outputData.technique; // Store technique for reveal
                container.querySelector('.svg-preview').innerHTML = outputData.svg;
                // Update shortcut hint to reflect actual visual position
                container.querySelector('.shortcut-hint').textContent = String.fromCharCode(65 + index); // A, B, C, D
            });
            
            resetRankingUI();
            selectedSVGId = null; // Reset keyboard selection
            updateProgressIndicator();
            sessionData.batchStartTime = Date.now();
            startBatchTimer();
        }
        
        function setupDragAndDrop() {
            const svgContainers = document.querySelectorAll('.svg-container');
            svgContainers.forEach(container => {
                container.addEventListener('dragstart', (e) => {
                    container.classList.add('dragging');
                    // Data transferred is the original ID of the SVG from the datastore
                    e.dataTransfer.setData('text/plain', container.dataset.outputId); 
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                container.addEventListener('dragend', () => {
                    container.classList.remove('dragging');
                });

                container.addEventListener('click', () => {
                    svgContainers.forEach(c => c.classList.remove('keyboard-selected'));
                    container.classList.add('keyboard-selected');
                    selectedSVGId = container.dataset.outputId;
                });
            });

            document.querySelectorAll('.ranking-slot').forEach(slot => {
                slot.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    slot.classList.add('drag-over');
                });
                
                slot.addEventListener('dragleave', () => {
                    slot.classList.remove('drag-over');
                });
                
                slot.addEventListener('drop', (e) => {
                    e.preventDefault();
                    slot.classList.remove('drag-over');
                    const droppedOutputId = e.dataTransfer.getData('text/plain');
                    if (droppedOutputId) {
                        assignRanking(slot.dataset.rank, droppedOutputId);
                    }
                });
            });
        }

        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (/^[1-4]$/.test(e.key)) { // If 1, 2, 3, or 4 is pressed
                    if (selectedSVGId) { // An SVG is selected by click
                        assignRanking(e.key, selectedSVGId);
                    } else { // If no SVG is clicked, map 1->A, 2->B etc.
                        const gridContainers = document.querySelectorAll('.svg-container');
                        const targetIndex = parseInt(e.key) -1;
                        if(gridContainers[targetIndex]){
                            const outputIdToRank = gridContainers[targetIndex].dataset.outputId;
                            // Rank it to the slot corresponding to the pressed key number
                            // e.g. pressing '1' for SVG 'A' ranks it as Best.
                            // This interpretation of "keyboard shortcut" might be complex.
                            // A simpler interpretation: select with A/B/C/D then rank with 1-4.
                            // For now, let's assume 1-4 means ranking the *selected* SVG into that slot.
                            // This logic is simplified to require click selection first for keyboard ranking.
                            // assignRanking(e.key, outputIdToRank); -- this would auto-rank to slot e.key
                        }
                    }
                } else if (e.key.toUpperCase() >= 'A' && e.key.toUpperCase() <= 'D') { // Select with A-D
                     const targetIndex = e.key.toUpperCase().charCodeAt(0) - 65; // A=0, B=1 ..
                     const gridContainers = document.querySelectorAll('.svg-container');
                     if(gridContainers[targetIndex]){
                        gridContainers.forEach(c => c.classList.remove('keyboard-selected'));
                        gridContainers[targetIndex].classList.add('keyboard-selected');
                        selectedSVGId = gridContainers[targetIndex].dataset.outputId;
                     }
                }
            });

            document.getElementById('submitBtn').addEventListener('click', submitCurrentRanking);
            document.getElementById('analyticsBtn').addEventListener('click', toggleAnalyticsPanel);
            document.getElementById('resetSessionBtn').addEventListener('click', resetSession);
        }

        function assignRanking(rank, outputIdToRank) {
            // Remove this outputId from any other rank
            for (const r in rankings) {
                if (rankings[r] === outputIdToRank) {
                    delete rankings[r];
                    clearSlotUI(r);
                }
            }
            // If something was already in the target rank, remove it
            if (rankings[rank]) {
                // This outputId is now unranked. It does not go back to grid.
                delete rankings[rank];
            }

            rankings[rank] = outputIdToRank;
            updateSlotUI(rank, outputIdToRank);
        }

        function updateSlotUI(rank, outputId) {
            const slot = document.querySelector(`.ranking-slot[data-rank="${rank}"]`);
            const originalSVGContainer = document.querySelector(`.svg-container[data-output-id="${outputId}"]`);
            const technique = originalSVGContainer.dataset.technique;

            const svgPreviewDiv = slot.querySelector('.svg-preview');
            svgPreviewDiv.innerHTML = ''; // Clear previous SVG
            const svgNode = originalSVGContainer.querySelector('svg').cloneNode(true);
            svgPreviewDiv.appendChild(svgNode);
            
            slot.querySelector('.technique-name').textContent = titleCase(technique.replace('-', ' '));
            slot.classList.remove('empty');
            slot.classList.add('filled');
        }
        
        function clearSlotUI(rank) {
            const slot = document.querySelector(`.ranking-slot[data-rank="${rank}"]`);
            slot.querySelector('.svg-preview').innerHTML = '';
            slot.querySelector('.technique-name').textContent = '';
            slot.classList.add('empty');
            slot.classList.remove('filled');
        }

        function resetRankingUI() {
            rankings = {};
            document.querySelectorAll('.ranking-slot').forEach(slot => {
                 clearSlotUI(slot.dataset.rank);
            });
            document.querySelectorAll('.svg-container').forEach(c => c.classList.remove('keyboard-selected'));
            selectedSVGId = null;
        }

        function submitCurrentRanking() {
            if (Object.keys(rankings).length < currentBatchOutputs.length) { // Check if all displayed SVGs are ranked
                alert(`Please rank all ${currentBatchOutputs.length} SVGs before submitting.`);
                return;
            }
            
            const timeTaken = (Date.now() - sessionData.batchStartTime) / 1000; // in seconds
            sessionData.evaluations.push({
                batchName: currentBatchName,
                prompt: svgDataStore[currentBatchName].prompt,
                rankings: { ...rankings }, // Store a copy
                timeTaken: timeTaken
            });
            sessionData.totalEvaluations++;
            
            // Update analytics data (simple version)
            updateAnalyticsDisplay();

            loadNextBatch();
        }
        
        let batchIntervalId = null;
        function startBatchTimer() {
            if(batchIntervalId) clearInterval(batchIntervalId);
            let seconds = 0;
            document.getElementById('batchTimer').textContent = "0s";
            batchIntervalId = setInterval(() => {
                seconds++;
                document.getElementById('batchTimer').textContent = seconds + "s";
            }, 1000);
        }

        function updateProgressIndicator() {
            document.getElementById('evalCount').textContent = sessionData.totalEvaluations;
            document.getElementById('currentBatchName').textContent = titleCase(currentBatchName);
        }
        
        function resetSession(){
            if(confirm("Are you sure you want to reset the entire session? All data will be lost.")){
                sessionData = { evaluations: [], totalEvaluations: 0, startTime: Date.now(), batchStartTime: null };
                evaluationCount = 0; // global used for display
                loadNextBatch();
                updateAnalyticsDisplay(); // Clear analytics
                 if(batchIntervalId) clearInterval(batchIntervalId);
                 document.getElementById('batchTimer').textContent = "0s";

            }
        }

        function updateAnalyticsDisplay() {
            document.getElementById('analyticsTotalEvals').textContent = sessionData.totalEvaluations;
            if (sessionData.totalEvaluations > 0) {
                const totalTime = sessionData.evaluations.reduce((sum, ev) => sum + ev.timeTaken, 0);
                document.getElementById('analyticsAvgTime').textContent = (totalTime / sessionData.totalEvaluations).toFixed(1) + "s";

                // Calculate win rates for chart and top tech
                const techStats = {};
                currentBatchOutputs.forEach(out => techStats[out.technique] = {wins:0, appearances:0});

                sessionData.evaluations.forEach(ev => {
                    for(const rank in ev.rankings){
                        const outputId = ev.rankings[rank];
                        // Find original output to get technique
                        let originalOutput = null;
                        for(const key in svgDataStore){
                            const found = svgDataStore[key].outputs.find(o => o.id === outputId);
                            if(found) {originalOutput = found; break;}
                        }

                        if(originalOutput){
                            const tech = originalOutput.technique;
                            if(!techStats[tech]) techStats[tech] = {wins:0, appearances:0};
                            techStats[tech].appearances++;
                            if(rank === "1") techStats[tech].wins++;
                        }
                    }
                });
                
                let topTech = "N/A";
                let maxWinRate = -1;
                const chartLabels = [];
                const chartData = [];

                for(const tech in techStats){
                    const rate = techStats[tech].appearances > 0 ? (techStats[tech].wins / techStats[tech].appearances) * 100 : 0;
                    chartLabels.push(titleCase(tech.replace('-',' ')));
                    chartData.push(rate.toFixed(1));
                    if(rate > maxWinRate){
                        maxWinRate = rate;
                        topTech = titleCase(tech.replace('-',' '));
                    }
                    if(tech === "baseline"){
                        document.getElementById('analyticsBaselineWins').textContent = rate.toFixed(0) + "%";
                    }
                }
                document.getElementById('analyticsTopTech').textContent = topTech;
                
                if(winRateChart){
                    winRateChart.data.labels = chartLabels;
                    winRateChart.data.datasets[0].data = chartData;
                    winRateChart.update();
                }


            } else {
                document.getElementById('analyticsAvgTime').textContent = "0s";
                document.getElementById('analyticsTopTech').textContent = "N/A";
                document.getElementById('analyticsBaselineWins').textContent = "0%";
                 if(winRateChart){ // Clear chart
                    winRateChart.data.labels = [];
                    winRateChart.data.datasets[0].data = [];
                    winRateChart.update();
                }
            }
        }
        
        function renderWinRateChart() { // Initial chart setup
            const ctx = document.getElementById('winRateChart').getContext('2d');
            winRateChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // To be populated by updateAnalyticsDisplay
                    datasets: [{
                        label: 'Rank #1 Rate (%)',
                        data: [], // To be populated
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ef4444', '#10b981', '#f59e0b'],
                        borderColor: ['#1d4ed8', '#7c3aed', '#dc2626', '#047857', '#d97706'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100, title: { display: true, text: 'Rank #1 Rate (%)'}},
                        y: { title: { display: true, text: 'Technique'}}
                    },
                    plugins: { legend: { display: false } }
                }
            });
            updateAnalyticsDisplay(); // Populate with initial (empty) data
        }


        function toggleAnalyticsPanel() {
            const panel = document.querySelector('.analytics-panel');
            panel.style.display = panel.style.display === 'none' || !panel.style.display ? 'block' : 'none';
             if(panel.style.display === 'block') updateAnalyticsDisplay(); // Refresh data when shown
        }

        // Helper functions
        function getRankIcon(rank) {
            return {'1': '🥇', '2': '🥈', '3': '🥉', '4': '❌'}[rank] || '';
        }
        function getRankLabel(rank) {
            return {'1': 'Best', '2': 'Good', '3': 'Fair', '4': 'Poor'}[rank] || '';
        }
        function titleCase(str) {
            return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
    </script>
</body>
</html>
